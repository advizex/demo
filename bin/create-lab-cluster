#!/bin/bash -e

[ -z "$DOCKER_EE_URL"] &&
  DOCKER_EE_URL='https://storebits.docker.com/ee/m/sub-39813958-ec09-443d-ae0d-d8925430530f'

echo -n "Creating Docker hosts..."
# ex: maas admin machines read | jq '.[].ip_addresses[0]'|tr -d '"'
for node in root@172.25.8.{2..4}; do
  ssh $node "zypper addrepo ${DOCKER_EE_URL}/sles/12.3/x86_64/stable-17.06 docker-ee-stable"
  ssh $node "rpm --import ${DOCKER_EE_URL}/sles/gpg"
  ssh $node "zypper refresh"
  ssh $node "zypper install -y docker-ee"
  ssh $node "service docker restart"
  #PID[$node]=$!
done

#wait ${PID[*]}
echo "done"

set -x
MASTER_IP=172.25.8.2

ssh root@$MASTER_IP "docker run --rm \
  --name ucp \
  -v /var/run/docker.sock:/var/run/docker.sock \
  docker/ucp:3.0.0-beta2 \
    install \
    --force-minimums \
    --host-address $MASTER_IP \
    --admin-username admin \
    --admin-password 12345678 \
    --san '$MASTER_IP'"


JOIN=$(ssh root@$MASTER_IP "docker swarm join-token worker | grep 'docker swarm join'")
for node in 172.25.8.{2..4}; do
  ssh root@$node "$JOIN"
done

echo "done"
