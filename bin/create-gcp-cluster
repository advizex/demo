#!/bin/bash -e

[ -z $1 ] && echo "Missing PREFIX" && exit

PREFIX=$1
echo "Create cluster: $1"
PROJECT_ID=$(gcloud projects list --format="value(projectId)")
echo "Project ID: $PROJECT_ID"

for node in {1..3}; do
  docker-machine create \
    --driver google \
    --google-project $PROJECT_ID \
    "${PREFIX}-${node}" &
  PID[$node]=$!
done

echo -n "Creating Docker hosts..."
wait ${PID[*]}
echo "done"

echo "Creating Swarm..."
eval $(docker-machine env ${PREFIX}-1)
docker swarm init 
JOIN=$(docker swarm join-token manager | grep 'docker swarm join')
eval $(docker-machine env ${PREFIX}-2)
$JOIN
eval $(docker-machine env ${PREFIX}-3)
$JOIN
echo "done"
